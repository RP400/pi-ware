#!/bin/bash

export PW_ACTION="$1"
export PW_PREFIX="$HOME/.local"

install_echo()
{
	if [[ "$PW_ACTION" != "update" ]]; then
		echo -e "$1"
	fi
}

# If executed directly from outside the repo
if [[ ! -d ".git" ]]; then
	git clone https://github.com/zachthecoder14/pi-ware.git
	cd pi-ware
fi

install_echo "Installing dependencies..."
sudo apt install -qq -y git python3 python3-tk

install_echo "Installing Pi-Ware..."
mkdir -p "$PW_PREFIX/share/applications"
mkdir -p "$PW_PREFIX/share/pi-ware"
mkdir -p "$PW_PREFIX/bin"
rsync -r ./{apps,uninstall,install,update} "$PW_PREFIX/share/pi-ware"
rsync ./store.py "$PW_PREFIX/bin/pi-ware"
chmod a+x "$PW_PREFIX/bin/pi-ware"
echo $(git rev-parse main) > "$PW_PREFIX/share/pi-ware/version"

if [[ "$PW_PREFIX" == "$HOME/.local" ]]; then
	echo "export PATH=$PW_PREFIX/bin:$PATH" >> $HOME/.bashrc
fi

install_echo "Creating a desktop entry for Pi-Ware..."
install_echo "[Desktop Entry]
Name=Pi-Ware
Comment=\"Raspberry Pi app store\"
Exec=sudo python3 $PW_PREFIX/bin/pi-ware
Icon=$PW_PREFIX/share/pixmaps/pi-ware.png
Categories=Utility;
Type=Application
Terminal=false" > "$PW_PREFIX/share/applications/pi-ware.desktop"
install_echo "Done! You can find Pi-Ware in Menu > Accessories > Pi-Ware."
install_echo "Note: you may need to restart your shell/terminal to be able to run Pi-Ware."
